(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[872],{5912:(e,s,a)=>{"use strict";a.r(s),a.d(s,{default:()=>c});var r=a(7876),n=a(4232),t=a(2982),i=a(806),l=a(7896),d=a(8230),o=a.n(d);function c(){let{token:e,role:s,authLoading:a}=(0,i.A)(),[d,c]=(0,n.useState)(null),[x,m]=(0,n.useState)(!0),[u,h]=(0,n.useState)(!1),[p,b]=(0,n.useState)("");async function g(){var e;if(!(null==d||null==(e=d.user)?void 0:e.id))return void alert("No hay usuario autenticado");h(!0);try{try{let e=await fetch("/api/make-admin",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({userId:d.user.id})});if((await e.json()).success){alert("\xa1Rol actualizado a admin con \xe9xito a trav\xe9s de la API! Por favor, recarga la p\xe1gina."),window.location.reload();return}}catch(e){console.error("Error con la API, intentando directamente con Supabase:",e)}let{error:e}=await t.N.from("users").update({rol:"admin"}).eq("id",d.user.id);e?alert("Error actualizando rol: ".concat(e.message,"\n\nPrueba usando el script SQL mostrado en la p\xe1gina.")):(alert("\xa1Rol actualizado a admin con \xe9xito! Por favor, recarga la p\xe1gina."),window.location.reload())}catch(e){alert("Error: ".concat(e.message))}finally{h(!1)}}return((0,n.useEffect)(()=>{!async function(){if(!a){m(!0);try{let{data:{session:a}}=await t.N.auth.getSession(),{data:{user:r}}=await t.N.auth.getUser();if(!a||!r){c({error:"No hay sesi\xf3n activa"}),m(!1);return}let{data:n,error:i}=await t.N.from("users").select("*").eq("id",r.id).single();if(c({session:{exists:!0,accessToken:a.access_token?"✅ Presente":"❌ Ausente",expiresAt:new Date(1e3*a.expires_at).toLocaleString()},user:{id:r.id,email:r.email,metadata:r.user_metadata},dbUser:n||null,contextRole:s,dbError:i?i.message:null}),r&&r.id){var e;let s="\n-- Ejecuta este script en Supabase SQL Editor para hacer admin a este usuario\nALTER TABLE users DISABLE ROW LEVEL SECURITY;\n\n-- Intentar actualizar el usuario existente\nUPDATE users \nSET rol = 'admin' \nWHERE id = '".concat(r.id,"';\n\n-- Si no existe, crear el usuario\nINSERT INTO users (id, nombre, rol)\nSELECT \n  '").concat(r.id,"'::uuid,\n  '").concat((null==(e=r.email)?void 0:e.split("@")[0])||"Admin","',\n  'admin'\nWHERE NOT EXISTS (\n  SELECT 1 FROM users WHERE id = '").concat(r.id,"'::uuid\n);\n\n-- Habilitar RLS nuevamente\nALTER TABLE users ENABLE ROW LEVEL SECURITY;\nALTER TABLE users FORCE ROW LEVEL SECURITY;\nGRANT SELECT, INSERT, UPDATE, DELETE ON users TO service_role;\n\n-- Verificar que se aplic\xf3 el cambio\nSELECT * FROM users WHERE id = '").concat(r.id,"'::uuid;\n          ");b(s)}}catch(e){c({error:e.message})}finally{m(!1)}}}()},[a,s]),x||a)?(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(l.A,{}),(0,r.jsx)("div",{className:"min-h-screen pt-24 p-6 flex items-center justify-center",children:(0,r.jsxs)("div",{className:"w-full max-w-2xl p-4 bg-white shadow rounded-xl",children:[(0,r.jsx)("h1",{className:"text-2xl font-bold mb-4",children:"Verificando permisos..."}),(0,r.jsx)("div",{className:"flex justify-center",children:(0,r.jsx)("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-dusk"})})]})})]}):(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(l.A,{}),(0,r.jsx)("div",{className:"min-h-screen pt-24 p-6 flex flex-col items-center justify-center",children:(0,r.jsxs)("div",{className:"w-full max-w-2xl p-4 bg-white shadow rounded-xl",children:[(0,r.jsx)("h1",{className:"text-2xl font-bold mb-4",children:"Verificaci\xf3n de Permisos Admin"}),(null==d?void 0:d.error)?(0,r.jsxs)("div",{className:"p-4 bg-red-100 text-red-800 rounded-lg mb-4",children:[(0,r.jsx)("p",{className:"font-bold",children:"Error:"}),(0,r.jsx)("p",{children:d.error})]}):(0,r.jsxs)(r.Fragment,{children:[(0,r.jsxs)("div",{className:"mb-4 p-4 bg-gray-100 rounded-lg",children:[(0,r.jsx)("h2",{className:"font-bold mb-2",children:"Estado de Autenticaci\xf3n:"}),(0,r.jsxs)("p",{children:["Rol en Contexto: ",(0,r.jsx)("span",{className:"font-mono",children:s||"ninguno"})]}),(0,r.jsxs)("p",{children:["Token: ",e?"✅ Presente":"❌ Ausente"]}),(null==d?void 0:d.session)&&(0,r.jsxs)("div",{className:"mt-2",children:[(0,r.jsxs)("p",{children:["Sesi\xf3n: ",d.session.exists?"✅ Activa":"❌ Inactiva"]}),(0,r.jsxs)("p",{children:["Access Token: ",d.session.accessToken]}),(0,r.jsxs)("p",{children:["Expira: ",d.session.expiresAt]})]})]}),(0,r.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 mb-4",children:[(0,r.jsxs)("div",{className:"p-4 bg-blue-100 rounded-lg",children:[(0,r.jsx)("h2",{className:"font-bold mb-2",children:"Usuario en Auth:"}),(null==d?void 0:d.user)?(0,r.jsxs)(r.Fragment,{children:[(0,r.jsxs)("p",{children:["Email: ",d.user.email]}),(0,r.jsxs)("p",{children:["ID: ",(0,r.jsx)("span",{className:"font-mono text-xs",children:d.user.id})]}),(0,r.jsx)("p",{className:"mt-2",children:"Metadata:"}),(0,r.jsx)("pre",{className:"bg-white p-2 rounded text-xs overflow-auto",children:JSON.stringify(d.user.metadata,null,2)})]}):(0,r.jsx)("p",{children:"No hay informaci\xf3n de usuario"})]}),(0,r.jsxs)("div",{className:"p-4 bg-green-100 rounded-lg",children:[(0,r.jsx)("h2",{className:"font-bold mb-2",children:"Usuario en Base de Datos:"}),(null==d?void 0:d.dbUser)?(0,r.jsxs)(r.Fragment,{children:[(0,r.jsxs)("p",{children:["Nombre: ",d.dbUser.nombre]}),(0,r.jsxs)("p",{children:["Rol: ",(0,r.jsx)("span",{className:"font-bold",children:d.dbUser.rol})]}),(0,r.jsxs)("p",{children:["ID: ",(0,r.jsx)("span",{className:"font-mono text-xs",children:d.dbUser.id})]}),(0,r.jsx)("pre",{className:"bg-white p-2 rounded text-xs overflow-auto mt-2",children:JSON.stringify(d.dbUser,null,2)})]}):(0,r.jsxs)("div",{children:[(0,r.jsx)("p",{className:"text-red-600",children:"⚠️ Usuario no encontrado en la base de datos"}),(null==d?void 0:d.dbError)&&(0,r.jsx)("p",{className:"text-sm text-red-600 mt-1",children:d.dbError})]})]})]}),(0,r.jsxs)("div",{className:"mb-4 p-4 bg-yellow-50 border border-yellow-200 rounded-lg",children:[(0,r.jsx)("h2",{className:"font-bold mb-2",children:"\xbfC\xf3mo arreglar permisos de Admin?"}),(0,r.jsxs)("ol",{className:"list-decimal list-inside space-y-1",children:[(0,r.jsx)("li",{children:'Intenta primero el bot\xf3n "Hacer Admin" a continuaci\xf3n'}),(0,r.jsx)("li",{children:"Si no funciona, copia el script SQL y ejec\xfatalo en Supabase"}),(0,r.jsx)("li",{children:"Para acceder a Supabase SQL Editor: Database → SQL Editor"}),(0,r.jsx)("li",{children:'Pega el script y haz clic en "Run"'}),(0,r.jsx)("li",{children:"Regresa a esta p\xe1gina y rec\xe1rgala para verificar"})]})]}),p&&(0,r.jsxs)("div",{className:"mb-4 p-4 bg-gray-100 rounded-lg",children:[(0,r.jsxs)("div",{className:"flex justify-between items-center mb-2",children:[(0,r.jsx)("h2",{className:"font-bold",children:"Script SQL para hacer admin:"}),(0,r.jsx)("button",{onClick:function(){navigator.clipboard.writeText(p).then(()=>alert("Script SQL copiado al portapapeles")).catch(e=>alert("Error al copiar: "+e))},className:"px-3 py-1 bg-gray-200 hover:bg-gray-300 rounded text-xs",children:"Copiar Script"})]}),(0,r.jsx)("pre",{className:"bg-gray-900 text-green-400 p-3 rounded text-xs overflow-auto",children:p})]}),(0,r.jsxs)("div",{className:"flex flex-wrap gap-2",children:[(0,r.jsx)("button",{onClick:g,disabled:u,className:"px-4 py-2 bg-dusk text-white rounded hover:bg-dusk/80 disabled:bg-gray-400",children:u?"Aplicando cambios...":"Hacer Admin"}),(0,r.jsx)(o(),{href:"/admin/dashboard",className:"px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700",children:"Dashboard Admin"}),(0,r.jsx)(o(),{href:"/auth-check",className:"px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700",children:"Verificar Auth"}),(0,r.jsx)("button",{onClick:()=>window.location.reload(),className:"px-4 py-2 bg-yellow-600 text-white rounded hover:bg-yellow-700",children:"Recargar P\xe1gina"})]})]})]})})]})}},6424:(e,s,a)=>{(window.__NEXT_P=window.__NEXT_P||[]).push(["/admin/check",function(){return a(5912)}])},7896:(e,s,a)=>{"use strict";a.d(s,{A:()=>d});var r=a(7876),n=a(8230),t=a.n(n),i=a(806),l=a(4232);function d(){let{token:e,role:s,authLoading:a,logout:n}=(0,i.A)(),[d,o]=(0,l.useState)("");return(0,l.useEffect)(()=>{{o(localStorage.getItem("name")||"");let e=()=>o(localStorage.getItem("name")||"");return window.addEventListener("storage",e),()=>window.removeEventListener("storage",e)}},[]),(0,l.useEffect)(()=>{o(localStorage.getItem("name")||"")},[e]),(0,r.jsx)("header",{className:"fixed top-0 inset-x-0 z-50",children:(0,r.jsxs)("nav",{className:"mx-auto max-w-6xl flex items-center justify-between p-4 md:p-6",children:[(0,r.jsx)(t(),{href:"/",className:"font-display text-xl md:text-2xl",children:"Sof\xeda & Franco"}),(0,r.jsxs)("div",{className:"flex flex-row gap-2 md:gap-4 items-center min-w-[140px] w-auto flex-nowrap",children:[!a&&"admin"!==s&&(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(t(),{href:"/rsvp",className:"px-3 py-2 md:px-4 md:py-2 rounded-full bg-dusk text-white hover:opacity-90 text-sm md:text-base text-center",children:"Confirmar asistencia"}),(0,r.jsx)(t(),{href:"/menu",className:"px-3 py-2 md:px-4 md:py-2 rounded-full bg-gold text-dusk hover:opacity-90 text-sm md:text-base text-center",children:"Men\xfa"})]}),!a&&("admin"===s||"admin@boda.com"===localStorage.getItem("email"))&&(0,r.jsx)(t(),{href:"/admin/dashboard",className:"px-3 py-2 md:px-4 md:py-2 rounded-full bg-blue-700 text-white hover:opacity-90 text-sm md:text-base text-center",children:"Panel de control"}),!a&&e?(0,r.jsxs)("div",{className:"flex items-center gap-2",children:[(0,r.jsx)("span",{className:"text-dusk text-sm font-semibold truncate max-w-[100px]",title:d||s||"Usuario",children:d||s||"Usuario"}),(0,r.jsx)("button",{onClick:n,className:"px-2 py-1 rounded-full bg-blush text-dusk border border-dusk/20 text-xs hover:bg-dusk hover:text-white transition",children:"Cerrar sesi\xf3n"}),("admin"===s||"prometidos"===s||"prometido"===s)&&(0,r.jsx)(t(),{href:"/debug",className:"px-2 py-1 rounded-full bg-gray-200 text-dusk border border-dusk/20 text-xs hover:bg-dusk hover:text-white transition",children:"Debug"})]}):(0,r.jsx)(t(),{href:"/login",className:"px-3 py-2 md:px-4 md:py-2 rounded-full bg-white border border-dusk/20 hover:bg-blush text-sm md:text-base text-center",children:"Login"})]})]})})}}},e=>{e.O(0,[230,636,593,792],()=>e(e.s=6424)),_N_E=e.O()}]);