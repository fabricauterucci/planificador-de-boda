(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[36],{4572:(e,s,t)=>{(window.__NEXT_P=window.__NEXT_P||[]).push(["/admin/dashboard",function(){return t(9480)}])},7896:(e,s,t)=>{"use strict";t.d(s,{A:()=>o});var a=t(7876),r=t(8230),n=t.n(r),i=t(806),l=t(4232);function o(){let{token:e,role:s,authLoading:t,logout:r}=(0,i.A)(),[o,d]=(0,l.useState)("");return(0,l.useEffect)(()=>{{d(localStorage.getItem("name")||"");let e=()=>d(localStorage.getItem("name")||"");return window.addEventListener("storage",e),()=>window.removeEventListener("storage",e)}},[]),(0,l.useEffect)(()=>{d(localStorage.getItem("name")||"")},[e]),(0,a.jsx)("header",{className:"fixed top-0 inset-x-0 z-50",children:(0,a.jsxs)("nav",{className:"mx-auto max-w-6xl flex items-center justify-between p-4 md:p-6",children:[(0,a.jsx)(n(),{href:"/",className:"font-display text-xl md:text-2xl",children:"Sof\xeda & Franco"}),(0,a.jsxs)("div",{className:"flex flex-row gap-2 md:gap-4 items-center min-w-[140px] w-auto flex-nowrap",children:[!t&&"admin"!==s&&(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(n(),{href:"/rsvp",className:"px-3 py-2 md:px-4 md:py-2 rounded-full bg-dusk text-white hover:opacity-90 text-sm md:text-base text-center",children:"Confirmar asistencia"}),(0,a.jsx)(n(),{href:"/menu",className:"px-3 py-2 md:px-4 md:py-2 rounded-full bg-gold text-dusk hover:opacity-90 text-sm md:text-base text-center",children:"Men\xfa"})]}),!t&&("admin"===s||"admin@boda.com"===localStorage.getItem("email"))&&(0,a.jsx)(n(),{href:"/admin/dashboard",className:"px-3 py-2 md:px-4 md:py-2 rounded-full bg-blue-700 text-white hover:opacity-90 text-sm md:text-base text-center",children:"Panel de control"}),!t&&e?(0,a.jsxs)("div",{className:"flex items-center gap-2",children:[(0,a.jsx)("span",{className:"text-dusk text-sm font-semibold truncate max-w-[100px]",title:o||s||"Usuario",children:o||s||"Usuario"}),(0,a.jsx)("button",{onClick:r,className:"px-2 py-1 rounded-full bg-blush text-dusk border border-dusk/20 text-xs hover:bg-dusk hover:text-white transition",children:"Cerrar sesi\xf3n"}),("admin"===s||"prometidos"===s||"prometido"===s)&&(0,a.jsx)(n(),{href:"/debug",className:"px-2 py-1 rounded-full bg-gray-200 text-dusk border border-dusk/20 text-xs hover:bg-dusk hover:text-white transition",children:"Debug"})]}):(0,a.jsx)(n(),{href:"/login",className:"px-3 py-2 md:px-4 md:py-2 rounded-full bg-white border border-dusk/20 hover:bg-blush text-sm md:text-base text-center",children:"Login"})]})]})})}},9099:(e,s,t)=>{e.exports=t(6296)},9480:(e,s,t)=>{"use strict";t.r(s),t.d(s,{default:()=>m});var a=t(7876),r=t(4232),n=t(2982),i=t(806),l=t(7896),o=t(8230),d=t.n(o),c=t(9099);function m(){let{role:e,authLoading:s}=(0,i.A)(),[t,o]=(0,r.useState)({total:0,confirmados:0,no_confirmados:0,porcentaje:0,menuStats:[]}),[m,x]=(0,r.useState)([]),[h,u]=(0,r.useState)(!0),[p,f]=(0,r.useState)(null),[b,g]=(0,r.useState)(null),[j,N]=(0,r.useState)(null),v=async e=>{if(confirm("\xbfEst\xe1s seguro de que quieres eliminar este usuario? Esta acci\xf3n no se puede deshacer.")){N(e);try{let s=await n.N.auth.getSession();if(!s.data.session)throw Error("No hay sesi\xf3n activa");let t=await fetch("/api/users/delete",{method:"DELETE",headers:{"Content-Type":"application/json",Authorization:"Bearer ".concat(s.data.session.access_token)},body:JSON.stringify({userId:e})});if(!t.ok){let e,s=t.headers.get("content-type");if(s&&s.includes("application/json"))e=await t.json();else{let s=await t.text();console.error("Respuesta no JSON:",s),e={message:"Error del servidor (".concat(t.status,"): ").concat(s.substring(0,100),"...")}}throw Error(e.message||"Error al eliminar usuario")}console.log("Usuario eliminado correctamente"),x(s=>s.filter(s=>s.id!==e)),o(e=>({...e,total:e.total-1,no_confirmados:e.no_confirmados-1,porcentaje:e.total>1?Math.round(e.confirmados/(e.total-1)*100):0}))}catch(e){console.error("Error completo:",e),f("Error al eliminar usuario: ".concat(e.message))}finally{N(null)}}};(0,r.useEffect)(()=>{let s;if("admin"===e||"prometido"===e)return t(),s=n.N.channel("dashboard-changes").on("postgres_changes",{event:"*",schema:"public",table:"rsvp"},()=>{t()}).on("postgres_changes",{event:"*",schema:"public",table:"users"},()=>{t()}).subscribe(),()=>{s&&n.N.removeChannel(s)};async function t(){if("admin"===e){u(!0),f(null);try{let{count:e}=await n.N.from("users").select("*",{count:"exact",head:!0}).eq("rol","invitado"),{data:s}=await n.N.from("rsvp").select("user_id, asistencia, menu, comentario"),{data:t}=await n.N.from("users").select("id, nombre, rol"),a=(t||[]).filter(e=>"invitado"===e.rol).map(e=>{let t=(s||[]).find(s=>s.user_id===e.id);return{...e,asistencia:(null==t?void 0:t.asistencia)||"no_confirmado",menu:(null==t?void 0:t.menu)||"",comentario:(null==t?void 0:t.comentario)||""}}),r=a.filter(e=>"asistire"===e.asistencia).length,i=a.length-r,l={};a.forEach(e=>{if("asistire"===e.asistencia){let s=e.menu?e.menu.trim():"Sin men\xfa seleccionado";l[s]=(l[s]||0)+1}}),o({total:e||0,confirmados:r,no_confirmados:i,porcentaje:e?Math.round(r/e*100):0,menuStats:Object.entries(l).map(e=>{let[s,t]=e;return{menu:s,cantidad:t}})}),x(a)}catch(e){f(e.message)}finally{u(!1)}}}},[e]);let w=(0,c.useRouter)();return((0,r.useEffect)(()=>{s||"admin"===e||"prometido"===e||w.replace("/")},[e,s,w]),s)?(0,a.jsx)("div",{children:"Cargando..."}):(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(l.A,{}),(0,a.jsxs)("main",{className:"pt-24 max-w-4xl mx-auto p-4",children:[(0,a.jsx)("h1",{className:"font-display text-2xl mb-6",children:"Dashboard de Invitados"}),(0,a.jsxs)("div",{className:"mb-4 flex gap-2 flex-wrap",children:[(0,a.jsx)(d(),{href:"/admin/users",className:"px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 inline-block",children:"Gestionar Usuarios"}),(0,a.jsx)(d(),{href:"/admin/rsvp-structure",className:"px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700 inline-block",children:"Verificar Estructura RSVP"})]}),h&&(0,a.jsx)("div",{children:"Cargando datos..."}),p&&(0,a.jsxs)("div",{className:"text-red-600",children:["Error: ",p]}),!h&&(0,a.jsxs)(a.Fragment,{children:[(0,a.jsxs)("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4 mb-8",children:[(0,a.jsxs)("div",{className:"bg-white rounded-xl shadow p-4 text-center",children:[(0,a.jsx)("div",{className:"text-3xl font-bold",children:t.total}),(0,a.jsx)("div",{className:"text-sm",children:"Total invitados"})]}),(0,a.jsxs)("div",{className:"bg-green-100 rounded-xl shadow p-4 text-center",children:[(0,a.jsx)("div",{className:"text-3xl font-bold",children:t.confirmados}),(0,a.jsx)("div",{className:"text-sm",children:"Confirmados"})]}),(0,a.jsxs)("div",{className:"bg-red-100 rounded-xl shadow p-4 text-center",children:[(0,a.jsx)("div",{className:"text-3xl font-bold",children:t.no_confirmados}),(0,a.jsx)("div",{className:"text-sm",children:"No confirmados"})]}),(0,a.jsxs)("div",{className:"bg-blue-100 rounded-xl shadow p-4 text-center",children:[(0,a.jsxs)("div",{className:"text-3xl font-bold",children:[t.porcentaje,"%"]}),(0,a.jsx)("div",{className:"text-sm",children:"% Asistencia"})]})]}),(0,a.jsxs)("div",{className:"mb-8",children:[(0,a.jsx)("h2",{className:"font-bold mb-2",children:"Men\xfas elegidos"}),(0,a.jsxs)("ul",{children:[t.menuStats.map(e=>(0,a.jsxs)("li",{children:[e.menu||"Sin men\xfa seleccionado",": ",(0,a.jsx)("b",{children:e.cantidad})]},e.menu||"sin-menu")),0===t.menuStats.length&&t.confirmados>0?(0,a.jsxs)("li",{children:["Hay ",t.confirmados," confirmados pero sin men\xfa seleccionado."]}):0===t.menuStats.length&&(0,a.jsx)("li",{children:"No hay confirmados a\xfan."})]})]}),(0,a.jsx)("div",{className:"overflow-x-auto",children:(0,a.jsxs)("table",{className:"w-full border mt-4",children:[(0,a.jsx)("thead",{children:(0,a.jsxs)("tr",{className:"bg-dusk text-white",children:[(0,a.jsx)("th",{className:"p-2",children:"Nombre"}),(0,a.jsx)("th",{className:"p-2",children:"Email/ID"}),(0,a.jsx)("th",{className:"p-2",children:"Rol"}),(0,a.jsx)("th",{className:"p-2",children:"Asistencia"}),(0,a.jsx)("th",{className:"p-2",children:"Men\xfa"}),(0,a.jsx)("th",{className:"p-2",children:"Comentario"}),(0,a.jsx)("th",{className:"p-2",children:"Acciones"})]})}),(0,a.jsx)("tbody",{children:m.map(e=>(0,a.jsxs)("tr",{className:"border-b",children:[(0,a.jsx)("td",{className:"p-2",children:e.nombre}),(0,a.jsx)("td",{className:"p-2",children:e.id}),(0,a.jsx)("td",{className:"p-2",children:e.rol}),(0,a.jsx)("td",{className:"p-2",children:"asistire"===e.asistencia?"✔️":"❌"}),(0,a.jsx)("td",{className:"p-2",children:e.menu}),(0,a.jsx)("td",{className:"p-2",children:e.comentario}),(0,a.jsx)("td",{className:"p-2",children:(0,a.jsx)("button",{onClick:()=>v(e.id),disabled:j===e.id||"admin"===e.rol||"prometido"===e.rol,className:"px-3 py-1 rounded text-sm ".concat("admin"===e.rol||"prometido"===e.rol?"bg-gray-100 text-gray-400 cursor-not-allowed":j===e.id?"bg-red-300 text-white cursor-wait":"bg-red-500 text-white hover:bg-red-600"),title:"admin"===e.rol||"prometido"===e.rol?"No se pueden eliminar usuarios admin o prometidos":"",children:j===e.id?"Eliminando...":"Eliminar"})})]},e.id))})]})})]})]})]})}}},e=>{e.O(0,[230,636,593,792],()=>e(e.s=4572)),_N_E=e.O()}]);