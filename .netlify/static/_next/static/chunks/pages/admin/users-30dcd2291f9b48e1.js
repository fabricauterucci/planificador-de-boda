(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[840],{88:(e,r,a)=>{"use strict";a.r(r),a.d(r,{default:()=>d});var t=a(7876),s=a(4232),o=a(2982),l=a(806),i=a(4780),n=a(7896);function d(){let{role:e,authLoading:r}=(0,l.A)(),[a,d]=(0,s.useState)([]),[c,u]=(0,s.useState)(!0),[m,x]=(0,s.useState)(null);async function h(e,r){try{let{success:t,error:s}=await (0,i.K)(e,r);if(!t)throw Error(s);d(a.map(a=>a.id===e?{...a,rol:r}:a)),alert("Rol actualizado para el usuario ".concat(e))}catch(e){console.error("Error al actualizar rol:",e),alert("Error al actualizar rol: ".concat(e.message,'. Usa la herramienta "Arreglar Pol\xedticas de Seguridad" para resolver este problema.'))}}return((0,s.useEffect)(()=>{!async function(){try{u(!0),x(null);let{data:e,error:r}=await o.N.from("users").select("*");r?(console.error("Error al cargar usuarios:",r),x(r.message),d([])):d(e||[])}catch(e){console.error("Error al cargar usuarios:",e),x(e.message),d([])}finally{u(!1)}}()},[]),r)?(0,t.jsx)("div",{children:"Cargando..."}):(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(n.A,{}),(0,t.jsxs)("main",{className:"pt-24 max-w-4xl mx-auto p-4",children:[(0,t.jsx)("h1",{className:"font-display text-2xl mb-6",children:"Gesti\xf3n de Usuarios"}),(0,t.jsxs)("div",{className:"mb-6",children:[(0,t.jsx)("a",{href:"/admin/fix-policies",className:"px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 inline-block",children:"Arreglar Pol\xedticas de Seguridad"}),(0,t.jsx)("p",{className:"mt-2 text-sm text-gray-600",children:'Si ves errores de "infinite recursion" en pol\xedticas, usa esta herramienta para corregirlos.'})]}),c?(0,t.jsx)("p",{children:"Cargando usuarios..."}):m?(0,t.jsxs)("div",{className:"text-red-600",children:["Error: ",m]}):(0,t.jsx)("div",{className:"overflow-x-auto",children:(0,t.jsxs)("table",{className:"w-full border",children:[(0,t.jsx)("thead",{children:(0,t.jsxs)("tr",{className:"bg-dusk text-white",children:[(0,t.jsx)("th",{className:"p-2",children:"ID"}),(0,t.jsx)("th",{className:"p-2",children:"Nombre"}),(0,t.jsx)("th",{className:"p-2",children:"Rol"}),(0,t.jsx)("th",{className:"p-2",children:"Acciones"})]})}),(0,t.jsxs)("tbody",{children:[a.map(e=>(0,t.jsxs)("tr",{className:"border-b",children:[(0,t.jsx)("td",{className:"p-2",children:e.id}),(0,t.jsx)("td",{className:"p-2",children:e.nombre||"-"}),(0,t.jsx)("td",{className:"p-2",children:e.rol||"-"}),(0,t.jsxs)("td",{className:"p-2",children:[(0,t.jsxs)("select",{value:e.rol||"invitado",onChange:r=>h(e.id,r.target.value),className:"p-1 border rounded mr-2",children:[(0,t.jsx)("option",{value:"invitado",children:"Invitado"}),(0,t.jsx)("option",{value:"admin",children:"Admin"}),(0,t.jsx)("option",{value:"prometidos",children:"Prometidos"})]}),(0,t.jsx)("button",{onClick:()=>h(e.id,"admin"===e.rol?"invitado":"admin"),className:"px-2 py-1 bg-blue-600 text-white rounded text-xs",children:"admin"===e.rol?"Quitar Admin":"Hacer Admin"})]})]},e.id)),0===a.length&&(0,t.jsx)("tr",{children:(0,t.jsx)("td",{colSpan:4,className:"p-4 text-center",children:"No hay usuarios registrados"})})]})]})})]})]})}},3432:(e,r,a)=>{(window.__NEXT_P=window.__NEXT_P||[]).push(["/admin/users",function(){return a(88)}])},4780:(e,r,a)=>{"use strict";a.d(r,{K:()=>s,r:()=>o});var t=a(2982);async function s(e,r){let a=arguments.length>2&&void 0!==arguments[2]&&arguments[2];try{let{data:{session:s}}=await t.N.auth.getSession(),o=null==s?void 0:s.access_token;if(!o)throw Error("No hay sesi\xf3n activa");let l=await fetch("/api/update-role",{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer ".concat(o)},body:JSON.stringify({userId:e,nuevoRol:r})}),i=await l.json();if(!l.ok)throw Error(i.error||"Error al actualizar rol");console.log("Rol actualizado correctamente:",i);let{data:{user:n}}=await t.N.auth.getUser();return((null==n?void 0:n.id)===e||a)&&(alert("Tu rol ha sido actualizado. Debes cerrar sesi\xf3n e iniciarla nuevamente para que los cambios surtan efecto."),a&&(await t.N.auth.signOut(),window.location.href="/login")),{success:!0,data:i}}catch(e){return console.error("Error al actualizar rol:",e.message),{success:!1,error:e.message}}}async function o(e){let r=arguments.length>1&&void 0!==arguments[1]&&arguments[1];try{let{data:{user:a}}=await t.N.auth.getUser();if(!a)throw Error("No hay usuario autenticado");let{success:o,error:l}=await s(a.id,e,r);if(!o)throw Error(l);return r||(localStorage.setItem("role",e),alert("Tu rol ha sido actualizado en la base de datos. Para aplicar todos los cambios, cierra sesi\xf3n e inicia sesi\xf3n nuevamente.")),{success:!0}}catch(e){return console.error("Error al actualizar rol propio:",e.message),{success:!1,error:e.message}}}},7896:(e,r,a)=>{"use strict";a.d(r,{A:()=>n});var t=a(7876),s=a(8230),o=a.n(s),l=a(806),i=a(4232);function n(){let{token:e,role:r,authLoading:a,logout:s}=(0,l.A)(),[n,d]=(0,i.useState)("");return(0,i.useEffect)(()=>{{d(localStorage.getItem("name")||"");let e=()=>d(localStorage.getItem("name")||"");return window.addEventListener("storage",e),()=>window.removeEventListener("storage",e)}},[]),(0,i.useEffect)(()=>{d(localStorage.getItem("name")||"")},[e]),(0,t.jsx)("header",{className:"fixed top-0 inset-x-0 z-50",children:(0,t.jsxs)("nav",{className:"mx-auto max-w-6xl flex items-center justify-between p-4 md:p-6",children:[(0,t.jsx)(o(),{href:"/",className:"font-display text-xl md:text-2xl",children:"Sof\xeda & Franco"}),(0,t.jsxs)("div",{className:"flex flex-row gap-2 md:gap-4 items-center min-w-[140px] w-auto flex-nowrap",children:[!a&&"admin"!==r&&(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(o(),{href:"/rsvp",className:"px-3 py-2 md:px-4 md:py-2 rounded-full bg-dusk text-white hover:opacity-90 text-sm md:text-base text-center",children:"Confirmar asistencia"}),(0,t.jsx)(o(),{href:"/menu",className:"px-3 py-2 md:px-4 md:py-2 rounded-full bg-gold text-dusk hover:opacity-90 text-sm md:text-base text-center",children:"Men\xfa"})]}),!a&&("admin"===r||"admin@boda.com"===localStorage.getItem("email"))&&(0,t.jsx)(o(),{href:"/admin/dashboard",className:"px-3 py-2 md:px-4 md:py-2 rounded-full bg-blue-700 text-white hover:opacity-90 text-sm md:text-base text-center",children:"Panel de control"}),!a&&e?(0,t.jsxs)("div",{className:"flex items-center gap-2",children:[(0,t.jsx)("span",{className:"text-dusk text-sm font-semibold truncate max-w-[100px]",title:n||r||"Usuario",children:n||r||"Usuario"}),(0,t.jsx)("button",{onClick:s,className:"px-2 py-1 rounded-full bg-blush text-dusk border border-dusk/20 text-xs hover:bg-dusk hover:text-white transition",children:"Cerrar sesi\xf3n"}),("admin"===r||"prometidos"===r||"prometido"===r)&&(0,t.jsx)(o(),{href:"/debug",className:"px-2 py-1 rounded-full bg-gray-200 text-dusk border border-dusk/20 text-xs hover:bg-dusk hover:text-white transition",children:"Debug"})]}):(0,t.jsx)(o(),{href:"/login",className:"px-3 py-2 md:px-4 md:py-2 rounded-full bg-white border border-dusk/20 hover:bg-blush text-sm md:text-base text-center",children:"Login"})]})]})})}}},e=>{e.O(0,[230,636,593,792],()=>e(e.s=3432)),_N_E=e.O()}]);