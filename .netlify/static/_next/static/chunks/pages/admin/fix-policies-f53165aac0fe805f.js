(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[56],{904:(e,a,s)=>{"use strict";s.r(a),s.d(a,{default:()=>l});var r=s(7876),n=s(4232),i=s(7896);function l(){let[e,a]=(0,n.useState)("idle"),[s,l]=(0,n.useState)(""),[t,c]=(0,n.useState)("");async function o(){a("loading"),l("Generando script SQL para corregir las pol\xedticas...");try{c('-- Este script corrige el error "infinite recursion detected in policy for relation users"\n-- eliminando todas las pol\xedticas actuales y creando nuevas que no causan recursi\xf3n\n\n-- 1. Primero, desactivamos RLS temporalmente para poder trabajar sin restricciones\nALTER TABLE public.users DISABLE ROW LEVEL SECURITY;\n\n-- 2. Eliminamos todas las pol\xedticas existentes para la tabla users\nDROP POLICY IF EXISTS "Users are viewable by everyone." ON public.users;\nDROP POLICY IF EXISTS "Users are editable by themselves." ON public.users;\nDROP POLICY IF EXISTS "Users are editable by admins." ON public.users;\nDROP POLICY IF EXISTS "Users are insertable by admins." ON public.users;\nDROP POLICY IF EXISTS "Users are deletable by admins." ON public.users;\nDROP POLICY IF EXISTS "Allow all users to view" ON public.users;\nDROP POLICY IF EXISTS "Allow users to update own record" ON public.users;\nDROP POLICY IF EXISTS "Allow admin@boda.com to update any record" ON public.users;\nDROP POLICY IF EXISTS "Allow insert for everyone" ON public.users;\nDROP POLICY IF EXISTS "Allow admin@boda.com to delete any record" ON public.users;\n\n-- 3. Creamos nuevas pol\xedticas que no causan recursi\xf3n\n-- IMPORTANTE: Estas pol\xedticas evitan el uso de subconsultas a la misma tabla\n\n-- Pol\xedtica para permitir a todos ver todos los usuarios\nCREATE POLICY "users_select_policy" \nON public.users \nFOR SELECT \nUSING (true);\n\n-- Pol\xedtica para permitir a los usuarios editar sus propios datos\nCREATE POLICY "users_update_self_policy" \nON public.users \nFOR UPDATE \nUSING (auth.uid() = id);\n\n-- Pol\xedtica para permitir a los administradores editar cualquier registro basado en email\nCREATE POLICY "users_update_admin_policy" \nON public.users \nFOR UPDATE \nUSING (auth.jwt() ->> \'email\' = \'admin@boda.com\');\n\n-- Pol\xedtica para permitir a cualquiera insertar (necesario para el registro)\nCREATE POLICY "users_insert_policy" \nON public.users \nFOR INSERT \nWITH CHECK (true);\n\n-- Pol\xedtica para permitir a los administradores eliminar cualquier registro\nCREATE POLICY "users_delete_admin_policy" \nON public.users \nFOR DELETE \nUSING (auth.jwt() ->> \'email\' = \'admin@boda.com\');\n\n-- 4. Volvemos a activar RLS\nALTER TABLE public.users ENABLE ROW LEVEL SECURITY;\n\n-- 5. Nos aseguramos de que la tabla tenga los campos correctos\nDO $$\nBEGIN\n  -- Verificar si existe la columna \'rol\' y si no, crearla\n  IF NOT EXISTS (\n    SELECT FROM information_schema.columns \n    WHERE table_schema = \'public\' \n    AND table_name = \'users\' \n    AND column_name = \'rol\'\n  ) THEN\n    ALTER TABLE public.users ADD COLUMN rol text DEFAULT \'invitado\';\n  END IF;\n  \n  -- Verificar si existe la columna \'nombre\' y si no, crearla\n  IF NOT EXISTS (\n    SELECT FROM information_schema.columns \n    WHERE table_schema = \'public\' \n    AND table_name = \'users\' \n    AND column_name = \'nombre\'\n  ) THEN\n    ALTER TABLE public.users ADD COLUMN nombre text;\n  END IF;\n  \n  -- Asegurarnos de que el ID sea la clave primaria\n  IF NOT EXISTS (\n    SELECT FROM pg_constraint\n    WHERE conname = \'users_pkey\'\n    AND conrelid = \'public.users\'::regclass\n  ) THEN\n    ALTER TABLE public.users ADD PRIMARY KEY (id);\n  END IF;\nEND\n$$;'),a("success"),l("Script SQL generado exitosamente. Sigue las instrucciones a continuaci\xf3n para aplicarlo.")}catch(e){a("error"),l("Error: ".concat(e.message)),console.error("Error completo:",e)}}return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(i.A,{}),(0,r.jsxs)("main",{className:"pt-24 max-w-4xl mx-auto p-4",children:[(0,r.jsx)("h1",{className:"font-display text-2xl mb-6",children:"Arreglar Pol\xedticas de Base de Datos"}),(0,r.jsxs)("div",{className:"mb-8 p-4 bg-white rounded-lg shadow",children:[(0,r.jsxs)("div",{className:"p-4 bg-red-50 border border-red-200 rounded-lg mb-6",children:[(0,r.jsx)("h2",{className:"font-bold text-lg text-red-700 mb-2",children:"Error detectado: Recursi\xf3n infinita"}),(0,r.jsx)("p",{className:"text-red-700",children:'Se ha detectado un error de recursi\xf3n infinita en las pol\xedticas de seguridad de la tabla "users". Este error ocurre cuando las pol\xedticas se referencian a s\xed mismas de manera circular.'})]}),(0,r.jsx)("p",{className:"mb-4",children:"Esta herramienta te ayudar\xe1 a corregir el problema generando un script SQL que puedes ejecutar en Supabase."}),"idle"===e&&(0,r.jsx)("button",{onClick:o,className:"px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700",children:"Generar Script de Correcci\xf3n"}),"loading"===e&&(0,r.jsxs)("div",{children:[(0,r.jsx)("p",{className:"mb-2",children:"Procesando..."}),(0,r.jsx)("p",{className:"text-gray-600",children:s})]}),"success"===e&&(0,r.jsxs)("div",{children:[(0,r.jsx)("p",{className:"font-bold mb-2 text-green-600",children:"\xa1Script generado correctamente!"}),(0,r.jsx)("p",{className:"mb-4",children:s}),(0,r.jsxs)("div",{className:"mb-6",children:[(0,r.jsx)("h3",{className:"font-bold mb-2",children:"Instrucciones:"}),(0,r.jsxs)("ol",{className:"list-decimal ml-6 space-y-2",children:[(0,r.jsx)("li",{children:"Copia el c\xf3digo SQL a continuaci\xf3n"}),(0,r.jsxs)("li",{children:["Abre el ",(0,r.jsx)("a",{href:"https://supabase.com/dashboard",target:"_blank",className:"text-blue-600 underline",children:"Panel de Supabase"})," y ve a tu proyecto"]}),(0,r.jsx)("li",{children:'Haz clic en "SQL Editor" en el men\xfa lateral'}),(0,r.jsx)("li",{children:"Crea un nuevo query, pega el c\xf3digo y ejec\xfatalo"}),(0,r.jsx)("li",{children:"Vuelve a esta aplicaci\xf3n y prueba la p\xe1gina de usuarios nuevamente"})]})]}),(0,r.jsxs)("div",{className:"mt-4",children:[(0,r.jsx)("h3",{className:"font-bold mb-2",children:"C\xf3digo SQL:"}),(0,r.jsxs)("div",{className:"relative",children:[(0,r.jsx)("button",{onClick:()=>{navigator.clipboard.writeText(t),alert("C\xf3digo copiado al portapapeles")},className:"absolute top-2 right-2 px-2 py-1 bg-gray-200 text-sm rounded hover:bg-gray-300",children:"Copiar"}),(0,r.jsx)("pre",{className:"mt-2 p-3 bg-gray-100 rounded overflow-x-auto text-xs max-h-80 overflow-y-auto",children:t})]})]}),(0,r.jsxs)("div",{className:"mt-6",children:[(0,r.jsx)("a",{href:"/admin/users",className:"px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 inline-block mr-4",children:"Volver a Gesti\xf3n de Usuarios"}),(0,r.jsx)("button",{onClick:()=>a("idle"),className:"px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 inline-block",children:"Reiniciar"})]})]}),"error"===e&&(0,r.jsxs)("div",{className:"text-red-600",children:[(0,r.jsx)("p",{className:"font-bold mb-2",children:"Error"}),(0,r.jsx)("p",{children:s}),(0,r.jsx)("button",{onClick:()=>a("idle"),className:"mt-4 px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300",children:"Intentar de nuevo"})]}),(0,r.jsxs)("div",{className:"mt-6 border-t pt-4",children:[(0,r.jsx)("h3",{className:"font-bold mb-2",children:"Explicaci\xf3n detallada del error:"}),(0,r.jsx)("p",{className:"mb-2",children:"El error \"infinite recursion detected in policy for relation 'users'\" ocurre cuando una pol\xedtica de seguridad en Supabase hace referencia a s\xed misma de manera circular. Espec\xedficamente:"}),(0,r.jsxs)("ul",{className:"list-disc ml-6 mt-2 space-y-1",children:[(0,r.jsx)("li",{children:'Cuando una pol\xedtica que controla el acceso a la tabla "users" incluye una condici\xf3n que necesita consultar la misma tabla "users"'}),(0,r.jsx)("li",{children:'Por ejemplo, si tienes una pol\xedtica que dice "un usuario puede editar registros si su rol es admin", pero para verificar el rol necesitas consultar la tabla users'}),(0,r.jsx)("li",{children:"Esto crea un bucle infinito: para verificar si puede acceder a users, necesita acceder a users, lo que requiere verificar si puede acceder a users, y as\xed sucesivamente"})]}),(0,r.jsx)("p",{className:"mt-2",children:'La soluci\xf3n implementada evita esta recursi\xf3n utilizando directamente atributos del token JWT (como el email) en lugar de consultar la tabla para verificar roles. De esta manera, la verificaci\xf3n de permisos no necesita consultar la tabla "users" y se rompe el ciclo.'})]})]})]})]})}},1128:(e,a,s)=>{(window.__NEXT_P=window.__NEXT_P||[]).push(["/admin/fix-policies",function(){return s(904)}])},7896:(e,a,s)=>{"use strict";s.d(a,{A:()=>c});var r=s(7876),n=s(8230),i=s.n(n),l=s(806),t=s(4232);function c(){let{token:e,role:a,authLoading:s,logout:n}=(0,l.A)(),[c,o]=(0,t.useState)("");return(0,t.useEffect)(()=>{{o(localStorage.getItem("name")||"");let e=()=>o(localStorage.getItem("name")||"");return window.addEventListener("storage",e),()=>window.removeEventListener("storage",e)}},[]),(0,t.useEffect)(()=>{o(localStorage.getItem("name")||"")},[e]),(0,r.jsx)("header",{className:"fixed top-0 inset-x-0 z-50",children:(0,r.jsxs)("nav",{className:"mx-auto max-w-6xl flex items-center justify-between p-4 md:p-6",children:[(0,r.jsx)(i(),{href:"/",className:"font-display text-xl md:text-2xl",children:"Sof\xeda & Franco"}),(0,r.jsxs)("div",{className:"flex flex-row gap-2 md:gap-4 items-center min-w-[140px] w-auto flex-nowrap",children:[!s&&"admin"!==a&&(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(i(),{href:"/rsvp",className:"px-3 py-2 md:px-4 md:py-2 rounded-full bg-dusk text-white hover:opacity-90 text-sm md:text-base text-center",children:"Confirmar asistencia"}),(0,r.jsx)(i(),{href:"/menu",className:"px-3 py-2 md:px-4 md:py-2 rounded-full bg-gold text-dusk hover:opacity-90 text-sm md:text-base text-center",children:"Men\xfa"})]}),!s&&("admin"===a||"admin@boda.com"===localStorage.getItem("email"))&&(0,r.jsx)(i(),{href:"/admin/dashboard",className:"px-3 py-2 md:px-4 md:py-2 rounded-full bg-blue-700 text-white hover:opacity-90 text-sm md:text-base text-center",children:"Panel de control"}),!s&&e?(0,r.jsxs)("div",{className:"flex items-center gap-2",children:[(0,r.jsx)("span",{className:"text-dusk text-sm font-semibold truncate max-w-[100px]",title:c||a||"Usuario",children:c||a||"Usuario"}),(0,r.jsx)("button",{onClick:n,className:"px-2 py-1 rounded-full bg-blush text-dusk border border-dusk/20 text-xs hover:bg-dusk hover:text-white transition",children:"Cerrar sesi\xf3n"}),("admin"===a||"prometidos"===a||"prometido"===a)&&(0,r.jsx)(i(),{href:"/debug",className:"px-2 py-1 rounded-full bg-gray-200 text-dusk border border-dusk/20 text-xs hover:bg-dusk hover:text-white transition",children:"Debug"})]}):(0,r.jsx)(i(),{href:"/login",className:"px-3 py-2 md:px-4 md:py-2 rounded-full bg-white border border-dusk/20 hover:bg-blush text-sm md:text-base text-center",children:"Login"})]})]})})}}},e=>{e.O(0,[230,636,593,792],()=>e(e.s=1128)),_N_E=e.O()}]);