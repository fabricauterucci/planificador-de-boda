(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[859],{691:(e,r,s)=>{"use strict";s.r(r),s.d(r,{default:()=>u});var a=s(7876),t=s(4232),l=s(9099),n=s(806),o=s(8230),d=s.n(o),i=s(2982),c=s(7896);function u(){let{role:e}=(0,n.A)(),r=(0,l.useRouter)(),[s,o]=(0,t.useState)(!0),[u,m]=(0,t.useState)(null),[x,p]=(0,t.useState)({}),[h,b]=(0,t.useState)({asistencia:"asistire",menu:"Men\xfa Test Manual",comentario:"Test manual"}),[N,j]=(0,t.useState)(null),[g,f]=(0,t.useState)([]),[y,v]=(0,t.useState)(null);async function w(){o(!0);try{let e=await fetch("/api/rsvp-structure");if(!e.ok){let r=await e.json();throw Error(r.error||"Error en API: ".concat(e.status))}let r=await e.json();p(r)}catch(e){console.error("Error:",e),m(e.message)}finally{o(!1)}}async function E(){try{let e=await fetch("/api/rls-policies"),r=await e.json();if(!e.ok)return void v(r.error||"Error obteniendo pol\xedticas RLS");f(r.policies||[])}catch(e){console.error("Error obteniendo pol\xedticas RLS:",e),v(e.message)}}async function S(){o(!0),m(null),j(null);try{let e,r,{data:{user:s}}=await i.N.auth.getUser();if(!s)throw Error("No hay usuario autenticado");console.log("Enviando datos de prueba:",{data:h,userId:s.id});let a=await fetch("/api/rsvp-structure",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({data:h,userId:s.id})});try{e=await a.text(),console.log("Respuesta del servidor:",e)}catch(r){e="No se pudo leer la respuesta",console.error("Error leyendo respuesta:",r)}try{r=JSON.parse(e)}catch(r){throw console.error("Error parseando JSON:",r),Error("Error al parsear respuesta: ".concat(e))}if(!a.ok){let e=r.error||r.message||"Error al crear registro de prueba",s=r.details?JSON.stringify(r.details):"";throw Error("".concat(e).concat(s?" - "+s:""))}j(r),await w()}catch(e){console.error("Error al crear RSVP de prueba:",e),m(e.message||"Error desconocido")}finally{o(!1)}}async function _(){o(!0),m(null);try{let{error:e}=await i.N.rpc("execute_sql",{sql_query:"\n          ALTER TABLE public.rsvp \n          ALTER COLUMN asistencia TYPE text,\n          DROP CONSTRAINT IF EXISTS rsvp_asistencia_check,\n          ADD CONSTRAINT rsvp_asistencia_check CHECK (asistencia IN ('asistire', 'no_puedo_ir'));\n          \n          ALTER TABLE public.rsvp\n          ALTER COLUMN menu TYPE text;\n        "});if(e){console.error("Error al ejecutar SQL directo:",e),m("No se pudo ejecutar SQL directamente. Por favor, ejecuta el script en el SQL Editor de Supabase.");return}let r=await fetch("/api/rsvp-structure"),s=await r.json();if(!r.ok)throw Error("Error al actualizar informaci\xf3n de tabla");p(s),alert("Estructura de tabla corregida exitosamente")}catch(e){console.error("Error al corregir tipos de columnas:",e),m("Error: ".concat(e.message||"Error desconocido"))}finally{o(!1)}}return((0,t.useEffect)(()=>{"admin"!==e&&"prometidos"!==e&&r.push("/login")},[e,r]),(0,t.useEffect)(()=>{("admin"===e||"prometidos"===e)&&(w(),E())},[e]),"admin"!==e&&"prometidos"!==e)?(0,a.jsx)("div",{className:"p-8",children:"Redirigiendo a login..."}):(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(c.A,{}),(0,a.jsxs)("div",{className:"max-w-4xl mx-auto p-6 pt-24",children:[(0,a.jsx)("h1",{className:"text-2xl font-bold mb-6",children:"Estructura de Tabla RSVP"}),(0,a.jsx)("div",{className:"mb-6",children:(0,a.jsx)(d(),{href:"/admin/dashboard",className:"px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700",children:"Volver al Dashboard"})}),u&&(0,a.jsxs)("div",{className:"bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4",children:[(0,a.jsx)("p",{className:"font-bold",children:"Error:"}),(0,a.jsx)("p",{children:u}),u.includes("SQL")&&(0,a.jsxs)("div",{className:"mt-2",children:[(0,a.jsx)("p",{className:"font-bold",children:"SQL para ejecutar en Supabase:"}),(0,a.jsx)("pre",{className:"bg-gray-800 text-white p-4 rounded overflow-auto text-sm mt-2",children:"\nALTER TABLE public.rsvp \nALTER COLUMN asistencia TYPE text,\nDROP CONSTRAINT IF EXISTS rsvp_asistencia_check,\nADD CONSTRAINT rsvp_asistencia_check CHECK (asistencia IN ('asistire', 'no_puedo_ir'));\n\nALTER TABLE public.rsvp\nALTER COLUMN menu TYPE text;\n                  "})]})]}),s?(0,a.jsx)("div",{className:"text-center py-8",children:"Cargando informaci\xf3n..."}):(0,a.jsxs)("div",{className:"space-y-6",children:[(0,a.jsxs)("div",{className:"bg-white p-6 rounded-lg shadow",children:[(0,a.jsx)("h2",{className:"text-xl font-bold mb-4",children:"Estructura de la Tabla"}),x.tableStructure&&x.tableStructure.length>0?(0,a.jsx)("div",{className:"overflow-x-auto",children:(0,a.jsxs)("table",{className:"min-w-full bg-white border",children:[(0,a.jsx)("thead",{children:(0,a.jsxs)("tr",{className:"bg-gray-200",children:[(0,a.jsx)("th",{className:"py-2 px-4 border",children:"Columna"}),(0,a.jsx)("th",{className:"py-2 px-4 border",children:"Tipo"}),(0,a.jsx)("th",{className:"py-2 px-4 border",children:"Nullable"}),(0,a.jsx)("th",{className:"py-2 px-4 border",children:"Default"})]})}),(0,a.jsx)("tbody",{children:x.tableStructure.map((e,r)=>(0,a.jsxs)("tr",{className:r%2==0?"bg-gray-50":"",children:[(0,a.jsx)("td",{className:"py-2 px-4 border font-medium",children:e.column_name}),(0,a.jsxs)("td",{className:"py-2 px-4 border ".concat("asistencia"===e.column_name&&"text"!==e.data_type||"menu"===e.column_name&&"text"!==e.data_type?"text-red-600 font-bold":""),children:[e.data_type,"asistencia"===e.column_name&&"text"!==e.data_type&&" ⚠️ Deber\xeda ser text","menu"===e.column_name&&"text"!==e.data_type&&" ⚠️ Deber\xeda ser text"]}),(0,a.jsx)("td",{className:"py-2 px-4 border",children:e.is_nullable}),(0,a.jsx)("td",{className:"py-2 px-4 border",children:e.column_default||"-"})]},r))})]})}):(0,a.jsx)("p",{className:"text-red-600",children:"No se pudo obtener la estructura de la tabla"}),(0,a.jsx)("div",{className:"mt-4",children:(0,a.jsx)("button",{onClick:_,className:"px-4 py-2 bg-yellow-600 text-white rounded hover:bg-yellow-700",disabled:s,children:"Corregir Estructura de Tabla"})})]}),(0,a.jsxs)("div",{className:"bg-white p-6 rounded-lg shadow",children:[(0,a.jsx)("h2",{className:"text-xl font-bold mb-4",children:"Datos de Muestra"}),x.sampleRecords&&x.sampleRecords.length>0?(0,a.jsx)("div",{className:"overflow-x-auto",children:(0,a.jsxs)("table",{className:"min-w-full bg-white border",children:[(0,a.jsx)("thead",{children:(0,a.jsxs)("tr",{className:"bg-gray-200",children:[(0,a.jsx)("th",{className:"py-2 px-4 border",children:"ID"}),(0,a.jsx)("th",{className:"py-2 px-4 border",children:"User ID"}),(0,a.jsx)("th",{className:"py-2 px-4 border",children:"Asistencia"}),(0,a.jsx)("th",{className:"py-2 px-4 border",children:"Men\xfa"}),(0,a.jsx)("th",{className:"py-2 px-4 border",children:"Comentario"})]})}),(0,a.jsx)("tbody",{children:x.sampleRecords.map((e,r)=>(0,a.jsxs)("tr",{className:r%2==0?"bg-gray-50":"",children:[(0,a.jsx)("td",{className:"py-2 px-4 border",children:e.id}),(0,a.jsx)("td",{className:"py-2 px-4 border",children:e.user_id}),(0,a.jsx)("td",{className:"py-2 px-4 border",children:!0===e.asistencia?"true ⚠️":!1===e.asistencia?"false ⚠️":e.asistencia}),(0,a.jsx)("td",{className:"py-2 px-4 border",children:e.menu||"-"}),(0,a.jsx)("td",{className:"py-2 px-4 border",children:e.comentario||"-"})]},r))})]})}):(0,a.jsx)("p",{className:"text-yellow-600",children:"No hay registros en la tabla"})]}),(0,a.jsxs)("div",{className:"bg-white p-6 rounded-lg shadow",children:[(0,a.jsx)("h2",{className:"text-xl font-bold mb-4",children:"Crear Registro de Prueba"}),(0,a.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4 mb-4",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"block mb-1 font-medium",children:"Asistencia"}),(0,a.jsxs)("select",{className:"w-full p-2 border rounded",value:h.asistencia,onChange:e=>b({...h,asistencia:e.target.value}),children:[(0,a.jsx)("option",{value:"asistire",children:"asistire"}),(0,a.jsx)("option",{value:"no_puedo_ir",children:"no_puedo_ir"})]})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"block mb-1 font-medium",children:"Men\xfa"}),(0,a.jsx)("input",{type:"text",className:"w-full p-2 border rounded",value:h.menu,onChange:e=>b({...h,menu:e.target.value})})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"block mb-1 font-medium",children:"Comentario"}),(0,a.jsx)("input",{type:"text",className:"w-full p-2 border rounded",value:h.comentario,onChange:e=>b({...h,comentario:e.target.value})})]})]}),(0,a.jsx)("button",{onClick:S,className:"px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700",disabled:s,children:s?"Procesando...":"Crear RSVP de Prueba"}),N&&(0,a.jsxs)("div",{className:"mt-4 p-4 bg-gray-100 rounded",children:[(0,a.jsx)("h3",{className:"font-bold mb-2",children:"Resultado:"}),(0,a.jsx)("pre",{className:"whitespace-pre-wrap text-sm",children:JSON.stringify(N,null,2)})]})]}),(0,a.jsxs)("div",{className:"bg-white p-6 rounded-lg shadow",children:[(0,a.jsx)("h2",{className:"text-xl font-bold mb-4",children:"Pol\xedticas de Seguridad (RLS)"}),(0,a.jsxs)("div",{className:"bg-yellow-100 border border-yellow-400 text-yellow-700 px-4 py-3 rounded mb-4",children:[(0,a.jsx)("p",{className:"font-bold",children:"Nota sobre pol\xedticas RLS:"}),(0,a.jsx)("p",{children:"Las pol\xedticas RLS (Row Level Security) controlan qu\xe9 filas puede ver, insertar o modificar cada usuario."}),(0,a.jsx)("p",{className:"mt-2",children:'Si recibes errores de "row-level security policy" al crear RSVPs, necesitas configurar las pol\xedticas RLS adecuadas en Supabase.'})]}),(0,a.jsx)("div",{className:"mt-4",children:(0,a.jsx)("a",{href:"/scripts/fix_rsvp_rls.sql",target:"_blank",rel:"noopener noreferrer",className:"px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 inline-block mr-2",children:"Ver Script de Correcci\xf3n RLS"})})]})]})]})]})}},3442:(e,r,s)=>{(window.__NEXT_P=window.__NEXT_P||[]).push(["/admin/rsvp-structure",function(){return s(691)}])},7896:(e,r,s)=>{"use strict";s.d(r,{A:()=>d});var a=s(7876),t=s(8230),l=s.n(t),n=s(806),o=s(4232);function d(){let{token:e,role:r,authLoading:s,logout:t}=(0,n.A)(),[d,i]=(0,o.useState)("");return(0,o.useEffect)(()=>{{i(localStorage.getItem("name")||"");let e=()=>i(localStorage.getItem("name")||"");return window.addEventListener("storage",e),()=>window.removeEventListener("storage",e)}},[]),(0,o.useEffect)(()=>{i(localStorage.getItem("name")||"")},[e]),(0,a.jsx)("header",{className:"fixed top-0 inset-x-0 z-50",children:(0,a.jsxs)("nav",{className:"mx-auto max-w-6xl flex items-center justify-between p-4 md:p-6",children:[(0,a.jsx)(l(),{href:"/",className:"font-display text-xl md:text-2xl",children:"Sof\xeda & Franco"}),(0,a.jsxs)("div",{className:"flex flex-row gap-2 md:gap-4 items-center min-w-[140px] w-auto flex-nowrap",children:[!s&&"admin"!==r&&(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(l(),{href:"/rsvp",className:"px-3 py-2 md:px-4 md:py-2 rounded-full bg-dusk text-white hover:opacity-90 text-sm md:text-base text-center",children:"Confirmar asistencia"}),(0,a.jsx)(l(),{href:"/menu",className:"px-3 py-2 md:px-4 md:py-2 rounded-full bg-gold text-dusk hover:opacity-90 text-sm md:text-base text-center",children:"Men\xfa"})]}),!s&&("admin"===r||"admin@boda.com"===localStorage.getItem("email"))&&(0,a.jsx)(l(),{href:"/admin/dashboard",className:"px-3 py-2 md:px-4 md:py-2 rounded-full bg-blue-700 text-white hover:opacity-90 text-sm md:text-base text-center",children:"Panel de control"}),!s&&e?(0,a.jsxs)("div",{className:"flex items-center gap-2",children:[(0,a.jsx)("span",{className:"text-dusk text-sm font-semibold truncate max-w-[100px]",title:d||r||"Usuario",children:d||r||"Usuario"}),(0,a.jsx)("button",{onClick:t,className:"px-2 py-1 rounded-full bg-blush text-dusk border border-dusk/20 text-xs hover:bg-dusk hover:text-white transition",children:"Cerrar sesi\xf3n"}),("admin"===r||"prometidos"===r||"prometido"===r)&&(0,a.jsx)(l(),{href:"/debug",className:"px-2 py-1 rounded-full bg-gray-200 text-dusk border border-dusk/20 text-xs hover:bg-dusk hover:text-white transition",children:"Debug"})]}):(0,a.jsx)(l(),{href:"/login",className:"px-3 py-2 md:px-4 md:py-2 rounded-full bg-white border border-dusk/20 hover:bg-blush text-sm md:text-base text-center",children:"Login"})]})]})})}},9099:(e,r,s)=>{e.exports=s(6296)}},e=>{e.O(0,[230,636,593,792],()=>e(e.s=3442)),_N_E=e.O()}]);