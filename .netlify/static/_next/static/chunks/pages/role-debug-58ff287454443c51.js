(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[682],{1150:(e,s,r)=>{"use strict";r.r(s),r.d(s,{default:()=>i});var l=r(7876),a=r(4232),t=r(2982),o=r(8230),n=r.n(o),d=r(7896);function i(){var e,s;let[r,o]=(0,a.useState)(!0),[i,c]=(0,a.useState)(null),[x,m]=(0,a.useState)(null),[u,h]=(0,a.useState)(!1);async function g(){var e;if(!(null==i||null==(e=i.user)?void 0:e.id))return void alert("No hay usuario autenticado");h(!0);try{let{data:e}=await t.N.from("users").select("rol").eq("id",i.user.id).single();if(!e)return void alert("No se encontr\xf3 el usuario en la base de datos");localStorage.setItem("role",e.rol),alert("Rol sincronizado: ".concat(e.rol)),window.location.reload()}catch(e){console.error("Error sincronizando rol:",e),alert("Error sincronizando rol")}finally{h(!1)}}return((0,a.useEffect)(()=>{!async function(){o(!0);try{let e=localStorage.getItem("token"),s=localStorage.getItem("role");m(s);let{data:{session:r}}=await t.N.auth.getSession(),{data:{user:l}}=await t.N.auth.getUser(),a=null,o=null;if(l){let{data:e,error:s}=await t.N.from("users").select("*").eq("id",l.id).single();a=e,o=null==e?void 0:e.rol}c({localStorage:{token:e?"Presente":"Ausente",role:s},session:r,user:l,dbUser:a,dbRole:o})}catch(e){console.error("Error obteniendo informaci\xf3n:",e),c({error:e})}finally{o(!1)}}()},[u]),r)?(0,l.jsxs)(l.Fragment,{children:[(0,l.jsx)(d.A,{}),(0,l.jsx)("div",{className:"min-h-screen p-8 flex justify-center items-center",children:(0,l.jsx)("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-gray-900"})})]}):(0,l.jsxs)(l.Fragment,{children:[(0,l.jsx)(d.A,{}),(0,l.jsxs)("div",{className:"min-h-screen p-4 pt-24 max-w-4xl mx-auto",children:[(0,l.jsx)("h1",{className:"text-2xl font-bold mb-6",children:"Depuraci\xf3n de Roles y Permisos"}),(0,l.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6 mb-6",children:[(0,l.jsxs)("div",{className:"bg-white p-4 rounded-lg shadow",children:[(0,l.jsx)("h2",{className:"text-lg font-bold mb-2",children:"Estado Local"}),(0,l.jsxs)("div",{className:"text-sm space-y-1",children:[(0,l.jsxs)("p",{children:[(0,l.jsx)("strong",{children:"Token:"})," ",null==i||null==(e=i.localStorage)?void 0:e.token]}),(0,l.jsxs)("p",{children:[(0,l.jsx)("strong",{children:"Rol en localStorage:"})," ",(0,l.jsx)("span",{className:"font-mono bg-yellow-100 px-1",children:x||"null"})]})]})]}),(0,l.jsxs)("div",{className:"bg-white p-4 rounded-lg shadow",children:[(0,l.jsx)("h2",{className:"text-lg font-bold mb-2",children:"Rol en Base de Datos"}),(0,l.jsxs)("div",{className:"text-sm space-y-1",children:[(0,l.jsxs)("p",{children:[(0,l.jsx)("strong",{children:"Usuario ID:"})," ",(0,l.jsx)("span",{className:"font-mono text-xs",children:(null==i||null==(s=i.user)?void 0:s.id)||"No autenticado"})]}),(0,l.jsxs)("p",{children:[(0,l.jsx)("strong",{children:"Rol en DB:"})," ",(0,l.jsx)("span",{className:"font-mono bg-blue-100 px-1",children:(null==i?void 0:i.dbRole)||"No encontrado"})]})]})]})]}),(0,l.jsxs)("div",{className:"mb-6 bg-white p-4 rounded-lg shadow",children:[(0,l.jsx)("h2",{className:"text-lg font-bold mb-2",children:"Datos de Usuario en DB"}),(null==i?void 0:i.dbUser)?(0,l.jsx)("pre",{className:"bg-gray-100 p-3 rounded text-xs overflow-auto",children:JSON.stringify(i.dbUser,null,2)}):(0,l.jsx)("p",{className:"text-red-600",children:"No se encontr\xf3 el usuario en la base de datos"})]}),(0,l.jsxs)("div",{className:"mb-6 bg-white p-4 rounded-lg shadow",children:[(0,l.jsx)("h2",{className:"text-lg font-bold mb-2",children:"Diagn\xf3stico"}),x!==(null==i?void 0:i.dbRole)?(0,l.jsxs)("div",{className:"bg-red-100 p-3 rounded text-sm",children:[(0,l.jsx)("p",{className:"font-bold text-red-700",children:"⚠️ Desincronizaci\xf3n de Roles"}),(0,l.jsxs)("p",{children:["El rol en localStorage (",x||"null",") no coincide con el rol en la base de datos (",(null==i?void 0:i.dbRole)||"null",")."]}),(0,l.jsx)("p",{className:"mt-2",children:'Esto puede causar problemas de autorizaci\xf3n. Usa el bot\xf3n "Sincronizar Rol" para corregirlo.'})]}):(0,l.jsxs)("div",{className:"bg-green-100 p-3 rounded text-sm",children:[(0,l.jsx)("p",{className:"font-bold text-green-700",children:"✅ Roles Sincronizados"}),(0,l.jsx)("p",{children:"El rol en localStorage coincide con el rol en la base de datos."})]})]}),(0,l.jsxs)("div",{className:"flex flex-wrap gap-3",children:[(0,l.jsx)("button",{onClick:g,disabled:u,className:"px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 disabled:bg-gray-400",children:u?"Sincronizando...":"Sincronizar Rol"}),(0,l.jsx)("button",{onClick:function(){localStorage.removeItem("token"),localStorage.removeItem("role"),alert("Datos de autenticaci\xf3n borrados de localStorage. Recomendamos cerrar sesi\xf3n y volver a iniciar."),window.location.reload()},className:"px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700",children:"Reiniciar Autenticaci\xf3n"}),(0,l.jsx)(n(),{href:"/admin/dashboard",className:"px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700",children:"Probar Dashboard"}),(0,l.jsx)(n(),{href:"/admin/check",className:"px-4 py-2 bg-purple-600 text-white rounded hover:bg-purple-700",children:"Check Admin"}),(0,l.jsx)("button",{onClick:()=>window.location.reload(),className:"px-4 py-2 bg-gray-600 text-white rounded hover:bg-gray-700",children:"Refrescar P\xe1gina"})]})]})]})}},3988:(e,s,r)=>{(window.__NEXT_P=window.__NEXT_P||[]).push(["/role-debug",function(){return r(1150)}])},7896:(e,s,r)=>{"use strict";r.d(s,{A:()=>d});var l=r(7876),a=r(8230),t=r.n(a),o=r(806),n=r(4232);function d(){let{token:e,role:s,authLoading:r,logout:a}=(0,o.A)(),[d,i]=(0,n.useState)("");return(0,n.useEffect)(()=>{{i(localStorage.getItem("name")||"");let e=()=>i(localStorage.getItem("name")||"");return window.addEventListener("storage",e),()=>window.removeEventListener("storage",e)}},[]),(0,n.useEffect)(()=>{i(localStorage.getItem("name")||"")},[e]),(0,l.jsx)("header",{className:"fixed top-0 inset-x-0 z-50",children:(0,l.jsxs)("nav",{className:"mx-auto max-w-6xl flex items-center justify-between p-4 md:p-6",children:[(0,l.jsx)(t(),{href:"/",className:"font-display text-xl md:text-2xl",children:"Sof\xeda & Franco"}),(0,l.jsxs)("div",{className:"flex flex-row gap-2 md:gap-4 items-center min-w-[140px] w-auto flex-nowrap",children:[!r&&"admin"!==s&&(0,l.jsxs)(l.Fragment,{children:[(0,l.jsx)(t(),{href:"/rsvp",className:"px-3 py-2 md:px-4 md:py-2 rounded-full bg-dusk text-white hover:opacity-90 text-sm md:text-base text-center",children:"Confirmar asistencia"}),(0,l.jsx)(t(),{href:"/menu",className:"px-3 py-2 md:px-4 md:py-2 rounded-full bg-gold text-dusk hover:opacity-90 text-sm md:text-base text-center",children:"Men\xfa"})]}),!r&&("admin"===s||"admin@boda.com"===localStorage.getItem("email"))&&(0,l.jsx)(t(),{href:"/admin/dashboard",className:"px-3 py-2 md:px-4 md:py-2 rounded-full bg-blue-700 text-white hover:opacity-90 text-sm md:text-base text-center",children:"Panel de control"}),!r&&e?(0,l.jsxs)("div",{className:"flex items-center gap-2",children:[(0,l.jsx)("span",{className:"text-dusk text-sm font-semibold truncate max-w-[100px]",title:d||s||"Usuario",children:d||s||"Usuario"}),(0,l.jsx)("button",{onClick:a,className:"px-2 py-1 rounded-full bg-blush text-dusk border border-dusk/20 text-xs hover:bg-dusk hover:text-white transition",children:"Cerrar sesi\xf3n"}),("admin"===s||"prometidos"===s||"prometido"===s)&&(0,l.jsx)(t(),{href:"/debug",className:"px-2 py-1 rounded-full bg-gray-200 text-dusk border border-dusk/20 text-xs hover:bg-dusk hover:text-white transition",children:"Debug"})]}):(0,l.jsx)(t(),{href:"/login",className:"px-3 py-2 md:px-4 md:py-2 rounded-full bg-white border border-dusk/20 hover:bg-blush text-sm md:text-base text-center",children:"Login"})]})]})})}}},e=>{e.O(0,[230,636,593,792],()=>e(e.s=3988)),_N_E=e.O()}]);