(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[105],{4850:(e,r,s)=>{(window.__NEXT_P=window.__NEXT_P||[]).push(["/auth-check",function(){return s(6269)}])},6269:(e,r,s)=>{"use strict";s.r(r),s.d(r,{default:()=>c});var t=s(7876),a=s(4232),l=s(2982),i=s(806),n=s(8230),d=s.n(n),o=s(7896);function c(){let{token:e,role:r,authLoading:s}=(0,i.A)(),[n,c]=(0,a.useState)(!0),[u,x]=(0,a.useState)(null),[m,h]=(0,a.useState)(!1);async function p(){var e,r,s,t,a;if(!(null==u||null==(e=u.directCheck)?void 0:e.userExists))return void alert("No hay sesi\xf3n activa. Debes iniciar sesi\xf3n primero.");h(!0);try{let e=u.directCheck.userId,i=u.directCheck.userEmail,{data:n,error:d}=await l.N.from("users").select("*").eq("id",e).single();if(d&&"PGRST116"!==d.code){console.error("Error al buscar usuario:",d),alert("Error al buscar usuario: ".concat(d.message)),h(!1);return}if(n)alert("El usuario ya existe en la tabla users"),x(e=>e?{...e,appUser:n}:null);else{let n=(null==(s=u.user)||null==(r=s.user_metadata)?void 0:r.name)||(null==(a=u.user)||null==(t=a.user_metadata)?void 0:t.full_name)||i.split("@")[0],{data:d,error:o}=await l.N.from("users").insert({id:e,nombre:n,rol:"invitado"}).select();o?(console.error("Error creando usuario:",o),alert("Error creando usuario: ".concat(o.message))):(alert("Usuario creado en la tabla users con \xe9xito"),x(r=>r?{...r,appUser:d&&d.length>0?d[0]:{id:e,nombre:n,rol:"invitado"}}:null))}let{data:o}=await l.N.auth.getSession();if(null==o?void 0:o.session){let{data:r}=await l.N.from("rsvp").select("*").eq("user_id",e).order("created_at",{ascending:!1}).limit(1);x(e=>e?{...e,rsvp:r&&r.length>0?r[0]:null}:null)}}catch(e){console.error("Error sincronizando:",e),alert("Error sincronizando: ".concat(e.message))}finally{h(!1)}}return((0,a.useEffect)(()=>{!async function(){c(!0);try{var e;let{data:r}=await l.N.auth.getSession(),s=(null==r||null==(e=r.session)?void 0:e.user)||null;if(x({authenticated:!!s,authSessionType:(null==r?void 0:r.session)?"active":"missing",user:s||null,directCheck:{sessionExists:!!(null==r?void 0:r.session),userExists:!!s,userId:null==s?void 0:s.id,userEmail:null==s?void 0:s.email}}),s)try{let{data:e,error:r}=await l.N.from("users").select("*").eq("id",s.id).single();r&&console.error("Error al buscar usuario en tabla users:",r);let{data:t,error:a}=await l.N.from("rsvp").select("*").eq("user_id",s.id).order("created_at",{ascending:!1}).limit(1);a&&console.error("Error al buscar RSVP:",a),x(r=>({...r,appUser:e||null,rsvp:t&&t.length>0?t[0]:null}))}catch(e){console.error("Error al consultar la base de datos:",e),x(r=>({...r,error:"Error de base de datos: ".concat(e.message)}))}}catch(e){console.error("Error verificando autenticaci\xf3n:",e),x({error:e.message})}finally{c(!1)}}()},[]),n||s)?(0,t.jsx)("div",{className:"min-h-screen p-6 flex flex-col items-center justify-center",children:(0,t.jsxs)("div",{className:"w-full max-w-4xl p-6 bg-white rounded-xl shadow-lg",children:[(0,t.jsx)("h1",{className:"text-2xl font-bold mb-4",children:"Verificando autenticaci\xf3n..."}),(0,t.jsx)("div",{className:"flex justify-center",children:(0,t.jsx)("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-dusk"})})]})}):(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(o.A,{}),(0,t.jsx)("div",{className:"min-h-screen p-6 flex flex-col items-center justify-center pt-20",children:(0,t.jsxs)("div",{className:"w-full max-w-4xl p-6 bg-white rounded-xl shadow-lg",children:[(0,t.jsx)("h1",{className:"text-2xl font-bold mb-4",children:"Estado de Autenticaci\xf3n"}),(0,t.jsxs)("div",{className:"mb-6 grid grid-cols-1 md:grid-cols-2 gap-4",children:[(0,t.jsxs)("div",{className:"p-4 border rounded-lg",children:[(0,t.jsx)("h2",{className:"text-lg font-semibold mb-2",children:"Contexto de Auth"}),(0,t.jsxs)("div",{className:"text-sm",children:[(0,t.jsxs)("p",{children:["Token: ",e?"✅ Presente":"❌ No hay token"]}),(0,t.jsxs)("p",{children:["Rol: ",r||"No definido"]})]})]}),(0,t.jsxs)("div",{className:"p-4 border rounded-lg",children:[(0,t.jsx)("h2",{className:"text-lg font-semibold mb-2",children:"Sesi\xf3n en Supabase"}),(0,t.jsxs)("div",{className:"text-sm",children:[(0,t.jsxs)("p",{children:["Autenticado: ",(null==u?void 0:u.authenticated)?"✅ S\xed":"❌ No"]}),(0,t.jsxs)("p",{children:["Tipo de sesi\xf3n: ",(null==u?void 0:u.authSessionType)||"Desconocido"]}),(null==u?void 0:u.directCheck)&&(0,t.jsxs)(t.Fragment,{children:[(0,t.jsxs)("p",{children:["Sesi\xf3n directa: ",u.directCheck.sessionExists?"✅ Existe":"❌ No existe"]}),(0,t.jsxs)("p",{children:["Usuario directo: ",u.directCheck.userExists?"✅ Existe":"❌ No existe"]})]})]})]})]}),(0,t.jsxs)("div",{className:"space-y-4",children:[(null==u?void 0:u.user)&&(0,t.jsxs)("div",{className:"p-4 border rounded-lg",children:[(0,t.jsx)("h2",{className:"text-lg font-semibold mb-2",children:"Usuario en Auth"}),(0,t.jsx)("pre",{className:"bg-gray-100 p-3 rounded text-xs overflow-auto",children:JSON.stringify(u.user,null,2)})]}),(null==u?void 0:u.appUser)&&(0,t.jsxs)("div",{className:"p-4 border rounded-lg",children:[(0,t.jsx)("h2",{className:"text-lg font-semibold mb-2",children:"Usuario en App"}),(0,t.jsx)("pre",{className:"bg-gray-100 p-3 rounded text-xs overflow-auto",children:JSON.stringify(u.appUser,null,2)})]}),(null==u?void 0:u.rsvp)&&(0,t.jsxs)("div",{className:"p-4 border rounded-lg",children:[(0,t.jsx)("h2",{className:"text-lg font-semibold mb-2",children:"RSVP Actual"}),(0,t.jsx)("pre",{className:"bg-gray-100 p-3 rounded text-xs overflow-auto",children:JSON.stringify(u.rsvp,null,2)})]}),(null==u?void 0:u.error)&&(0,t.jsxs)("div",{className:"p-4 border border-red-300 bg-red-50 rounded-lg",children:[(0,t.jsx)("h2",{className:"text-lg font-semibold mb-2 text-red-700",children:"Error"}),(0,t.jsx)("pre",{className:"bg-red-100 p-3 rounded text-xs overflow-auto text-red-800",children:JSON.stringify(u.error,null,2)})]})]}),(0,t.jsxs)("div",{className:"mt-6 flex flex-wrap gap-3",children:[(0,t.jsx)("button",{onClick:p,disabled:m,className:"px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 disabled:bg-gray-400",children:m?"Sincronizando...":"Sincronizar Auth"}),(0,t.jsx)(d(),{href:"/login",className:"px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700",children:"Ir al Login"}),(0,t.jsx)("button",{onClick:async()=>{await l.N.auth.signOut(),alert("Sesi\xf3n cerrada"),x(null)},className:"px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700",children:"Cerrar Sesi\xf3n"}),(0,t.jsx)(d(),{href:"/",className:"px-4 py-2 bg-gray-600 text-white rounded hover:bg-gray-700",children:"Volver al Inicio"})]})]})})]})}},7896:(e,r,s)=>{"use strict";s.d(r,{A:()=>d});var t=s(7876),a=s(8230),l=s.n(a),i=s(806),n=s(4232);function d(){let{token:e,role:r,authLoading:s,logout:a}=(0,i.A)(),[d,o]=(0,n.useState)("");return(0,n.useEffect)(()=>{{o(localStorage.getItem("name")||"");let e=()=>o(localStorage.getItem("name")||"");return window.addEventListener("storage",e),()=>window.removeEventListener("storage",e)}},[]),(0,n.useEffect)(()=>{o(localStorage.getItem("name")||"")},[e]),(0,t.jsx)("header",{className:"fixed top-0 inset-x-0 z-50",children:(0,t.jsxs)("nav",{className:"mx-auto max-w-6xl flex items-center justify-between p-4 md:p-6",children:[(0,t.jsx)(l(),{href:"/",className:"font-display text-xl md:text-2xl",children:"Sof\xeda & Franco"}),(0,t.jsxs)("div",{className:"flex flex-row gap-2 md:gap-4 items-center min-w-[140px] w-auto flex-nowrap",children:[!s&&"admin"!==r&&(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(l(),{href:"/rsvp",className:"px-3 py-2 md:px-4 md:py-2 rounded-full bg-dusk text-white hover:opacity-90 text-sm md:text-base text-center",children:"Confirmar asistencia"}),(0,t.jsx)(l(),{href:"/menu",className:"px-3 py-2 md:px-4 md:py-2 rounded-full bg-gold text-dusk hover:opacity-90 text-sm md:text-base text-center",children:"Men\xfa"})]}),!s&&("admin"===r||"admin@boda.com"===localStorage.getItem("email"))&&(0,t.jsx)(l(),{href:"/admin/dashboard",className:"px-3 py-2 md:px-4 md:py-2 rounded-full bg-blue-700 text-white hover:opacity-90 text-sm md:text-base text-center",children:"Panel de control"}),!s&&e?(0,t.jsxs)("div",{className:"flex items-center gap-2",children:[(0,t.jsx)("span",{className:"text-dusk text-sm font-semibold truncate max-w-[100px]",title:d||r||"Usuario",children:d||r||"Usuario"}),(0,t.jsx)("button",{onClick:a,className:"px-2 py-1 rounded-full bg-blush text-dusk border border-dusk/20 text-xs hover:bg-dusk hover:text-white transition",children:"Cerrar sesi\xf3n"}),("admin"===r||"prometidos"===r||"prometido"===r)&&(0,t.jsx)(l(),{href:"/debug",className:"px-2 py-1 rounded-full bg-gray-200 text-dusk border border-dusk/20 text-xs hover:bg-dusk hover:text-white transition",children:"Debug"})]}):(0,t.jsx)(l(),{href:"/login",className:"px-3 py-2 md:px-4 md:py-2 rounded-full bg-white border border-dusk/20 hover:bg-blush text-sm md:text-base text-center",children:"Login"})]})]})})}}},e=>{e.O(0,[230,636,593,792],()=>e(e.s=4850)),_N_E=e.O()}]);